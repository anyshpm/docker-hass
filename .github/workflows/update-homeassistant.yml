name: Update Home Assistant Version

on:
  push:
    branches: [ "*" ]
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version is the same'
        type: boolean
        default: false

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“‹ Get versions
        id: versions
        run: |
          CURRENT=$(grep -oP 'FROM homeassistant/home-assistant:\K[^\s]+' Dockerfile)
          LATEST=$(curl -s "https://registry.hub.docker.com/v2/repositories/homeassistant/home-assistant/tags?page_size=100&ordering=last_updated" | \
            jq -r '.results[] | select(.name | test("^[0-9]{4}\\.[0-9]+\\.[0-9]+$")) | .name' | \
            sort -V | tail -1)
          
          # Validate versions
          [[ -z "$CURRENT" || -z "$LATEST" || "$LATEST" == "null" ]] && exit 1
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Current: $CURRENT, Latest: $LATEST"



      - name: ğŸ”„ Check if update needed
        id: compare
        run: |
          CURRENT="${{ steps.versions.outputs.current }}"
          LATEST="${{ steps.versions.outputs.latest }}"
          
          if [ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ… Update needed: $CURRENT -> $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Already up to date: $CURRENT"
          fi

      - name: ğŸ› ï¸ Update files
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          CURRENT="${{ steps.versions.outputs.current }}"
          LATEST="${{ steps.versions.outputs.latest }}"
          
          # Update Dockerfile
          sed -i "s/FROM homeassistant\/home-assistant:$CURRENT/FROM homeassistant\/home-assistant:$LATEST/g" Dockerfile
          
          # Update README badges
          sed -i "s/Home%20Assistant-[0-9]\{4\}\.[0-9]\+\.[0-9]\+-blue/Home%20Assistant-${LATEST}-blue/g" README.md
          
          echo "âœ… Files updated: $CURRENT -> $LATEST"

      - name: ğŸ§ª Test build
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          docker build --no-cache -t test-build .
          docker run --rm -d --name test-container test-build || true
          sleep 10
          
          if docker ps -a --filter "name=test-container" --format "{{.Status}}" | grep -qE "(Exited \(0\)|Up)"; then
            echo "âœ… Build and smoke test passed"
          else
            echo "âŒ Test failed"
            docker logs test-container 2>/dev/null || true
            exit 1
          fi
          
          docker rm -f test-container 2>/dev/null || true



      - name: ğŸš€ Create branch and commit
        if: steps.compare.outputs.needs_update == 'true'
        id: commit
        run: |
          LATEST="${{ steps.versions.outputs.latest }}"
          BRANCH="update-homeassistant-${LATEST}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b "$BRANCH"
          git add Dockerfile README.md
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”„ Update Home Assistant to $LATEST"
            git push origin "$BRANCH"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "âœ… Changes committed and pushed"
          else
            echo "âŒ No changes to commit"
            exit 1
          fi



      - name: ğŸ“‹ Create Pull Request
        if: steps.compare.outputs.needs_update == 'true' && steps.commit.outputs.branch
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.versions.outputs.current }}';
            const latest = '${{ steps.versions.outputs.latest }}';
            const branch = '${{ steps.commit.outputs.branch }}';
            
            const title = `ğŸ”„ Update Home Assistant to ${latest}`;
            const body = `## ğŸ“‹ Summary
            - **Previous**: \`${current}\`
            - **New**: \`${latest}\`
            - **Date**: ${new Date().toUTCString()}
            
            ## ğŸ§ª Tests Passed
            - âœ… Docker build successful
            - âœ… Container smoke test passed
            
            ## ğŸ“š Release Notes
            https://github.com/home-assistant/core/releases/tag/${latest}`;
            
            const bases = ['main', 'master'];
            for (const base of bases) {
              try {
                const { data: pr } = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title, head: branch, base, body
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['automated-update', 'homeassistant-version']
                });
                
                console.log(`âœ… Created PR #${pr.number}: ${pr.html_url}`);
                return;
              } catch (error) {
                if (base === bases[bases.length - 1]) throw error;
              }
            }

      - name: ğŸ“§ Send Email Notification
        if: steps.compare.outputs.needs_update == 'true' && steps.commit.outputs.branch
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Home Assistant Update PR Created - ${{ steps.versions.outputs.latest }}"
          body: |
            Hello,
            
            An automated update PR has been created for Home Assistant version ${{ steps.versions.outputs.latest }}.
            
            Previous version: ${{ steps.versions.outputs.current }}
            New version: ${{ steps.versions.outputs.latest }}
            
            Please review and merge the PR when possible.
            
            PR Link: https://github.com/${{ github.repository }}/pulls
            Repository: https://github.com/${{ github.repository }}
            
            This is an automated message from the Home Assistant Docker image update workflow.
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_FROM }}>

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ”„ Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Current | Latest | Updated |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.versions.outputs.current }}\` | \`${{ steps.versions.outputs.latest }}\` | ${{ steps.compare.outputs.needs_update }} |" >> $GITHUB_STEP_SUMMARY

